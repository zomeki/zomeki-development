## ZOMEKI development インストールマニュアル

**********************************************************************
 1 想定環境
**********************************************************************

[システム]
OS         : CentOS 6.4
Webサーバ  : Apache 2.2
DBシステム : MySQL 5.1
Ruby       : 2.0
Rails      : 3.2

[設定]
ドメイン   : zomeki.example.com

**********************************************************************
 2 作業ユーザの変更
**********************************************************************

rootユーザに変更します。

  $ su -

**********************************************************************
 3 SELinux の無効化
**********************************************************************

SELinuxを無効にします。

  # /usr/sbin/setenforce 0

自動起動を無効にします。

  # vi /etc/sysconfig/selinux
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  SELINUX=disabled    # 変更
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  ※セキュリティ設定は環境に応じて適切に設定してください。

**********************************************************************
 4 事前準備
**********************************************************************

yumリポジトリにEPELを追加します。

  # rpm -ivh http://dl.fedoraproject.org/pub/epel/6/`uname -i`/epel-release-6-8.noarch.rpm

必要なパッケージをインストールします。

  # yum -y install wget git

**********************************************************************
 5 Ruby のインストール
**********************************************************************

Rubyをインストールします。

  # yum install -y gcc-c++ libffi-devel libyaml-devel make openssl-devel readline-devel zlib-devel

  # cd /usr/local/src
  # wget ftp://ftp.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p247.tar.gz
  # tar zxf ruby-2.0.0-p247.tar.gz && cd ruby-2.0.0-p247 && ./configure && make && make install

**********************************************************************
 6 ZOMEKI のインストール
**********************************************************************

専用ユーザを作成します。

  # useradd -m zomeki

ZOMEKIをインストールします。

  # yum install -y ImageMagick-devel libxml2-devel libxslt-devel mysql-devel openldap-devel

  # git clone https://github.com/zomeki/zomeki-development.git /var/share/zomeki
  # chown -R zomeki:zomeki /var/share/zomeki
  # cd /var/share/zomeki && gem install bundler && bundle install --without development test

  # cp /var/share/zomeki/config/samples/zomeki_logrotate /etc/logrotate.d/.

**********************************************************************
 7 Apache のインストール
**********************************************************************

Apacheをインストールします。

  # yum install -y httpd-devel shared-mime-info

設定ファイルを変更します。

  # vi /etc/httpd/conf/httpd.conf
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  ServerName zomeki.example.com    # 変更
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Phusion Passengerをインストールします。

  # yum install -y curl-devel

  # gem install passenger -v 4.0.21
  # passenger-install-apache2-module
  # cp /var/share/zomeki/config/samples/passenger.conf /etc/httpd/conf.d/passenger.conf

  # vi /etc/httpd/conf.d/passenger.conf
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  ※「PASSENGER_VERSION」をすべて「4.0.21」に書き換えます。
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

**********************************************************************
 8 MySQL のインストール
**********************************************************************

MySQLをインストールします

  # yum install -y mysql-server

設定ファイルを変更します。

  # vi /etc/my.cnf
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  [mysqld]
  character-set-server=utf8   # 追記
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  [client]                    # 末尾に追記
  default-character-set=utf8  # 末尾に追記
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

初期設定をします。

  # mysql_install_db --user=mysql
  # service mysqld start
  # mysql_secure_installation
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  Enter current password for root (enter for none): # そのままEnter
  Set root password? [Y/n]                          # そのままEnter
  New password:                                     # rootのパスワードを*決めて*入力
  Re-enter new password:                            # 同じパスワードを再度入力
  Remove anonymous users? [Y/n]                     # そのままEnter
  Disallow root login remotely? [Y/n]               # そのままEnter
  Remove test database and access to it? [Y/n]      # そのままEnter
  Reload privilege tables now? [Y/n]                # そのままEnter
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # mysql -u root -p -e "GRANT ALL ON zomeki_production.* TO zomeki@localhost IDENTIFIED BY 'zomekipass'"
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  Enter password:                                   # rootのパスワードを入力
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # service mysqld stop

**********************************************************************
 9 ZOMEKI の設定
**********************************************************************

設定ファイルのサンプルをコピーして変更します。

  # cp -p /var/share/zomeki/config/core.yml.sample /var/share/zomeki/config/core.yml
  # vi /var/share/zomeki/config/core.yml
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  uri: http://zomeki.example.com/    # すべて変更
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

設定ファイルのサンプルをコピーします。

  # cp -p /var/share/zomeki/config/virtual-hosts/sites.conf.sample /var/share/zomeki/config/virtual-hosts/sites.conf

設定ファイルのサンプルをコピーして変更します。

  # cp -p /var/share/zomeki/config/virtual-hosts/zomeki.conf.sample /var/share/zomeki/config/virtual-hosts/zomeki.conf
  # vi /var/share/zomeki/config/virtual-hosts/zomeki.conf
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  ServerName zomeki.example.com    # 変更
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # ln -s /var/share/zomeki/config/virtual-hosts/zomeki.conf /etc/httpd/conf.d/zomeki.conf

必要なデータベースを作ります。

  # service mysqld start
  # su - zomeki -c 'cd /var/share/zomeki && bundle exec rake db:setup RAILS_ENV=production'
  # service mysqld stop

**********************************************************************
 10 ふりがな・読み上げ機能 のインストール
**********************************************************************

hts_engine APIをインストールします。

  # cd /usr/local/src
  # wget http://downloads.sourceforge.net/hts-engine/hts_engine_API-1.07.tar.gz
  # tar xvzf hts_engine_API-1.07.tar.gz && cd hts_engine_API-1.07 && ./configure && make && make install

Open JTalkをインストールします。

  # cd /usr/local/src
  # wget http://downloads.sourceforge.net/open-jtalk/open_jtalk-1.06.tar.gz
  # tar xvzf open_jtalk-1.06.tar.gz && cd open_jtalk-1.06
  # sed -i "s/#define MAXBUFLEN 1024/#define MAXBUFLEN 10240/" bin/open_jtalk.c
  # ./configure --with-charset=UTF-8 && make && make install

Dictionaryをインストールします。

  # cd /usr/local/src
  # wget http://downloads.sourceforge.net/open-jtalk/open_jtalk_dic_utf_8-1.06.tar.gz
  # tar xvzf open_jtalk_dic_utf_8-1.06.tar.gz
  # mkdir /usr/local/share/open_jtalk && mv open_jtalk_dic_utf_8-1.06 /usr/local/share/open_jtalk/dic

SoXをインストールします。

  # cd /usr/local/src
  # wget http://sourceforge.net/projects/sox/files/sox/14.4.1/sox-14.4.1.tar.gz/download
  # tar xvzf sox-14.4.1.tar.gz && cd sox-14.4.1 && ./configure && make && make install

LAMEをインストールします。

  # cd /usr/local/src
  # wget http://jaist.dl.sourceforge.net/project/lame/lame/3.99/lame-3.99.5.tar.gz
  # tar zxf lame-3.99.5.tar.gz && cd lame-3.99.5 && ./configure && make && make install

MeCabをインストールします。

  # cd /usr/local/src
  # wget http://mecab.googlecode.com/files/mecab-0.996.tar.gz
  # tar xvzf mecab-0.996.tar.gz && cd mecab-0.996 && ./configure --enable-utf8-only && make && make install

MeCab-IPAdicをインストールします。

  # cd /usr/local/src
  # wget http://mecab.googlecode.com/files/mecab-ipadic-2.7.0-20070801.tar.gz
  # tar xvzf mecab-ipadic-2.7.0-20070801.tar.gz && cd mecab-ipadic-2.7.0-20070801 && ./configure --with-charset=utf8 && make && make install

MeCab-Rubyをインストールします。

  # cd /usr/local/src
  # wget http://mecab.googlecode.com/files/mecab-ruby-0.996.tar.gz
  # tar xvzf mecab-ruby-0.996.tar.gz && cd mecab-ruby-0.996 && ruby extconf.rb && make && make install

**********************************************************************
 11 Apache/MySQL の起動
**********************************************************************

  # service httpd configtest && service httpd start && chkconfig httpd on
  # service mysqld start && chkconfig mysqld on

**********************************************************************
 12 定期実行処理 の設定
**********************************************************************

ユーザzomekiのcronに処理を追加します。

  # crontab -u zomeki -e
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  # 記事の公開/非公開処理を行います。
  0-45/15 * * * * /usr/local/bin/ruby /var/share/zomeki/script/rails runner -e production "Script.run('sys/script/tasks/exec')"

  # トップページや中間ページを静的ファイルとして書き出します。
  3-48/15 * * * * /usr/local/bin/ruby /var/share/zomeki/script/rails runner -e production "Script.run('cms/script/nodes/publish')"

  # 音声ファイルを静的ファイルとして書き出します。
  6-51/15 * * * * /usr/local/bin/ruby /var/share/zomeki/script/rails runner -e production "Script.run('cms/script/talk_tasks/exec')"

  # 新着記事ポータルで設定したAtomフィードを取り込みます。
  0 * * * * /usr/local/bin/ruby /var/share/zomeki/script/rails runner -e production "Script.run('cms/script/feeds/read')"
  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

**********************************************************************
 13 動作確認
**********************************************************************

インストールが完了しました。

  公開画面 : http://zomeki.example.com/

  管理画面 : http://zomeki.example.com/_system

    管理者（システム管理者）
      ユーザID   : zomeki
      パスワード : zomeki

１．MySQL の zomeki ユーザはパスワードが zomekipass に設定されています。適宜変更してください。
    mysql> SET PASSWORD FOR zomeki@localhost = PASSWORD('newpass');
    また、変更時には /var/share/zomeki/config/database.yml も合わせて変更してください。
    # vi /var/share/zomeki/config/database.yml
